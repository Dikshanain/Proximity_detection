<!-- client.html -->
<!DOCTYPE html>
<html>
  <body>
    <button id="start">Enable location + connect</button>
    <button id="stop">Disconnect</button>
    <pre id="log"></pre>

    <script>
      let ws = null;
      let timer = null;
      let reconnectTimer = null;

      // Stable user id for this device
      let userId = localStorage.getItem("prox_user_id");
      if (!userId) {
        userId = "user_" + Math.floor(Math.random() * 100000);
        localStorage.setItem("prox_user_id", userId);
      }

      const radiusKm = 30; // city-wide radius

      const log = (m) => {
        document.getElementById("log").textContent += m + "\n";
      };

      function startConnection() {
        if (!navigator.geolocation) {
          alert("Geolocation not supported");
          return;
        }

        // Avoid double connections
        if (
          ws &&
          (ws.readyState === WebSocket.OPEN ||
            ws.readyState === WebSocket.CONNECTING)
        ) {
          log("Already connected / connecting");
          return;
        }

        log("Opening WebSocketâ€¦");
        ws = new WebSocket(
          "wss://proximity-service-production.up.railway.app/ws"
        );

        ws.onopen = () => {
          ws.send(
            JSON.stringify({
              type: "identify",
              user_id: userId,
              radius_km: radiusKm,
            })
          );
          log("Connected as " + userId + " radius_km=" + radiusKm);

          const sendLoc = () => {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const { latitude, longitude } = pos.coords;
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(
                    JSON.stringify({
                      type: "location",
                      latitude,
                      longitude,
                    })
                  );
                  log(
                    "Sent location: " +
                      latitude.toFixed(5) +
                      ", " +
                      longitude.toFixed(5)
                  );
                }
              },
              (err) => {
                log("Location error: " + err.message);
              },
              { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
          };

          // Send immediately, then every 5s
          sendLoc();
          if (timer) clearInterval(timer);
          timer = setInterval(sendLoc, 5000);
        };

        ws.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          if (msg.type === "proximity") {
            log(
              `found_nearby=${msg.found_nearby} count=${msg.count_nearby} sample=${JSON.stringify(
                msg.sample
              )}`
            );
          } else if (msg.type === "ack") {
            log("ACK: radius_km=" + msg.radius_km);
          } else if (msg.type === "error") {
            log("Error: " + msg.error);
          }
        };

        ws.onerror = () => {
          log("WebSocket error");
          if (ws) ws.close();
        };

        ws.onclose = () => {
          log("Disconnected, retrying in 3s");
          if (timer) clearInterval(timer);
          if (reconnectTimer) clearTimeout(reconnectTimer);
          reconnectTimer = setTimeout(() => {
            startConnection();
          }, 3000);
        };
      }

      document.getElementById("start").onclick = () => {
        startConnection();
      };

      document.getElementById("stop").onclick = () => {
        // stop auto-reconnect and location timer
        if (reconnectTimer) clearTimeout(reconnectTimer);
        if (timer) clearInterval(timer);

        if (ws) {
          // prevent onclose from triggering reconnect when we manually stop
          ws.onclose = null;
          ws.close();
        }
        log("Manual disconnect");
      };
    </script>
  </body>
</html>
